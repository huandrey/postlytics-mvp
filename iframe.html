<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tag Manager Iframe</title>
  <script src="https://unpkg.com/web-vitals@3/dist/web-vitals.iife.js"></script>
</head>
<body>
  <h2>Iframe (Tag Manager)</h2>

  <!-- Elementos a serem observados -->
  <button data-element="compra">Comprar</button>
  <div data-track style="margin-top: 600px;">Produto visível ao rolar</div>

  <script>
    const sendToHost = (type, payload) => {
      window.parent.postMessage({ type, payload }, "*");
    };

    // === Web Vitals ===
    webVitals.getCLS((metric) => sendToHost("WEB_VITAL", metric));
    webVitals.getFID((metric) => sendToHost("WEB_VITAL", metric));
    webVitals.getLCP((metric) => sendToHost("WEB_VITAL", metric));

    // === JS Errors ===
    window.onerror = (msg, url, line, col, err) => {
      sendToHost("ERROR", {
        message: msg,
        file: url,
        line,
        col,
        stack: err?.stack || null
      });
    };

    window.addEventListener("unhandledrejection", (event) => {
      sendToHost("ERROR", {
        message: "Unhandled Promise rejection",
        reason: event.reason
      });
    });

    // === Impressões ===
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          sendToHost("IMPRESSION", {
            element: entry.target.tagName,
            trackId: entry.target.getAttribute("data-track")
          });
          observer.unobserve(entry.target); // só uma vez
        }
      });
    });

    document.querySelectorAll("[data-track]").forEach(el => observer.observe(el));

    // === Cliques em elementos ===
    document.addEventListener("click", (e) => {
      const el = e.target.closest("[data-element]");
      if (el) {
        sendToHost("CLICK", {
          element: el.tagName,
          id: el.getAttribute("data-element"),
          timestamp: Date.now()
        });
      }
    });

    // === Recebe contexto do host ===
    window.addEventListener("message", (event) => {
      const { type, payload } = event.data || {};
      if (type === "INIT_CONTEXT") {
        console.log("[IFRAME] Contexto recebido:", payload);
        // salvar localmente se quiser
      }
    });

    // Simular erro JS só pra teste:
    setTimeout(() => {
      throw new Error("Erro simulado do iframe");
    }, 3000);
  </script>
</body>
</html>
